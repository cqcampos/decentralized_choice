
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: 22-user 8-core network, expiring 30 Jun 2026
Serial number: 501909306443
  Licensed to: The University of Chicago Booth School of Business
               Mercury Computing Cluster

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do /project/lausd/decentralized_choice/code/0_build_data/b_build_mle_data.do 

. /****************************************************************************
> ****
> - Author: Chris Campos
> - Antonia Edited the path files to follow the folders restructuration 
> - Description: some preliminary analysis of magnet programs 
> - Date started: 12/17/2024
> - Last update: 07/24/2025
> *****************************************************************************
> **/
. clear all

. set trace on

. set tracedepth 2

. set maxvar 120000


. 
. capture program drop main

. program define main
  1. 
.         set_paths
  2. 
.         
.         prepStudentData, minYr(2004) maxYr(2008)
  3. 
.         * Extrat subset of applications for relevant years 
.         prepApplications, minYr(2004) maxYr(2008)
  4. 
.         /* Prep magnet schools */ 
.         isolateSchools
  5.         isolateApplications
  6. 
.         /* Calculate distances */
.         calculateDistances 
  7. 
.         /* Prep structural data */
.        prepStructuralData
  8. 
.         /* Admission probabilities */ 
.         prepareSeats
  9.         student_p_i
 10. end

. 
. *****************************************************************************
> ***
. * set_paths 
. * 
. * Description: Establish paths 
. *****************************************************************************
> ***
. capture program drop set_paths

. program define set_paths
  1. 
.     * Establish directories 
.     if "`c(os)'"=="MacOSX" & "`c(username)'"=="cqcampos"{
  2.         global ROOT /Volumes/lausd/decentralized_choice 
  3.         global BUILD /Volumes/lausd/build/output/data
  4.         global ROOTSOURCE "/Volumes/lausd/build/" 
  5.         global magnet "/Volumes/lausd/magnet/"
  6.     }
  7.     else{
  8.             global ROOT "/project/lausd/decentralized_choice"
  9.             global BUILD "/project/lausd/build/output/data"
 10.             global ROOTSOURCE "/project/lausd/build/" 
 11.             global magnet "/project/lausd/magnet"
 12. 
.     }
 13.         
.     global DTARAW "$ROOT/rawdata" 
 14.     global RAW $ROOT/data/raw
 15.     global DTAFINAL "$ROOT/data" 
 16.     global tables "$ROOT/tables"
 17.     global figures "$ROOT/figures"
 18. 
.     * Raw source data
.     global UE "$ROOTSOURCE/rawdata/Campos_Master_DUA/Unified_Enrollment"
 19.     global RAWOUT "$ROOTSOURCE/output/data" 
 20. 
. 
. end

. 
. 
. *****************************************************************************
> ***
. * prepStudentData 
. * 
. * Description: Preps relevant fifth grade cohort student data 
. *****************************************************************************
> ***
. capture program drop prepStudentData 

. program define prepStudentData 
  1. syntax, [minYr(int 2004) maxYr(int 2017)]
  2.         /*
>     use "$BUILD/magnet_rank.dta", clear
>     keep if choice_ranking ==1
>     contract mag_cd_ endyear
>     drop if _freq<=10 // those that have less than 10 apps are usually data e
> ntry errors
>     drop _freq 
>     rename mag_cd_ next_scode 
>     drop if next_scode==. 
>     tempfile tempcodes 
>     save `tempcodes'
> 
> 
>     * Create offer dummies (not conditioning on lottery) THIS DATA IS NOW CRE
> ATED IN 0_build.do and store in "./decentralized_choice/data/raw/magnet_offer
> s.dta"
>     import delimited "$UE/Deidentified_NEW_MAG_ALL.csv", clear stringcols(_al
> l)
>     destring application_id school_yr, replace
>     merge 1:1 application_id using "$RAWOUT/apps_time_stamp.dta"
>     drop _merge
>     replace app_endyear = school_yr if missing(app_endyear) // so we don;t lo
> se the 2023, 2024 people
>     sort student_pseudo_id
>     rename (student_pseudo_id ) (studentpseudoid) 
>     gen magnet_offer = mag_action_1=="B" | mag_action_2 =="B" | mag_action_3=
> ="B"
>     contract studentpseudoid app_endyear magnet_offer
>     gen endyear = app_endyear //just to use for the match in the build code 
>     drop _freq 
>     duplicates drop studentpseudoid endyear, force 
>     save "$magnetINT/magnet_offers.dta", replace 
>         */
. 
.     * Read in main sample, merge magnet offers, and create necessary variable
> s 
.     use if endyear >=`minYr' & endyear <=(`maxYr' +1)  using $RAWOUT/lausd200
> 1_2023_encoded.dta, clear 
  3.     merge m:1 studentpseudoid endyear using $RAW/magnet_offers, gen(mergeO
> ffers) keep( 1 3)
  4.     drop mergeOffers 
  5.     gen appliedMagnet = mergeMagnet ==3
  6.     egen sid = group(studentpseudoid)
  7. 
.     xtset sid endyear 
  8.     decode schoollocationname, gen(sname)
  9.     gen next_schoolname = F1.schoollocationname
 10.     label values next_schoolname schoollocationname_
 11.     gen next_scode = F1.schoolcostcentercode 
 12.     decode next_schoolname, gen(next_sname)
 13.     gen F1math = F1.z_math_all 
 14.     gen F1ela = F1.z_ela_all
 15.     gen F2math = F2.z_math_all
 16.     gen F2ela = F2.z_ela_all
 17.     gen F3math = F3.z_math_all
 18.     gen F3ela = F3.z_ela_all
 19. 
.     egen avg_Fmath = rowmean(F1math F2math F3math)
 20.     egen avg_Fela = rowmean(F1ela F2ela F3ela)
 21. 
.     gen hispanic = ethnicitydescription==1
 22.     gen black = ethnicitydescription==2
 23.     gen white = ethnicitydescription==3
 24.     gen asian= ethnicitydescription==4 
 25.     gen other = hispanic==0 & black==0 & white==0 & asian==0 
 26.     gen female = gendercode==1
 27.     gen poverty = studentpovertyindicator==3
 28.     gen el = languageclasscode==3
 29.     gen gifted = !missing(studentgiftedprogramdescription) 
 30. 
.     gen sixthGradeAddress = censusblockid1 if gradecode ==6
 31.     bys studentpseudoid : egen addressSix = mean(sixthGradeAddress )
 32.     replace censusblockid1 = addressSix if missing(censusblockid1 ) & grad
> ecode ==5
 33.     keep if gradecode==5
 34. 
.     gen schooltype = "ms" if gradecode ==5
 35.     
.     rename censusblockid1 censusblockid
 36.     decode censusblockid, gen(blockid)  
 37.     rename (censusblockid blockid) (blockid censusblockid)
 38.     merge m:1 censusblockid schooltype endyear using $DTAFINAL/intermediat
> e/magnet_distances.dta  , gen(mergeDistances) keep(1 3)
 39. 
.     gen next_mag = regexm(next_sname , "MAG") | regexm(next_sname, "MG")    
 40. 
. 
.     drop city2 api_city2 api_state2 api_zip_code2 censusblockid2 city3 api_ci
> ty3 api_state3 api_zip_code3 censusblockid3 ///
>         city4 api_city4 api_state4 api_zip_code4 censusblockid4 city5 api_cit
> y5 api_state5 api_zip_code5 censusblockid5 ///
>         city6 api_city6 api_state6 api_zip_code6 censusblockid6 city7 api_cit
> y7 api_state7 api_zip_code7 censusblockid7 ///
>         city8 api_city8 api_state8 api_zip_code8 censusblockid8 city9 api_cit
> y9 api_state9 api_zip_code9 censusblockid9 ///
>         sbac_ela sbac_math mergeSBAC ss_cst_ela1 ss_cst_math1 ss_cst_ela2 ss_
> cst_math2 numTests testid mergeCST ///
>         effective_date2 zip_code2 effective_date3 zip_code3 effective_date4 z
> ip_code4 effective_date5 zip_code5 effective_date6 zip_code6 effective_date7 
> zip_code7 effective_date8 zip_code8 effective_date9 zip_code9 mergeAddresses 
> ///
>         ethnicitydescription gendercode parentedulevelname preferredlocationn
> ame schoollocationname studentbirthcountry studentusschoolfirstattenddate lan
> guageclasscode homelanguagedescription studentspedflag studentgiftedprogramde
> scription studentpovertyindicator overallperformancelevelnameELA overallperfo
> rmancelevelnameMath testnameela1 testnamemath1 testnameela2 testnamemath2 per
> f_cst_ela1 perf_cst_math1 perf_cst_ela2 perf_cst_math2 ///
>         sixthGradeAddress addressSix 
 41. 
.     save $DTAFINAL/lausd_5thgrade_cohorts_`minYr'_`maxYr'.dta, replace
 42. 
. end 

. 
. 
. capture program drop prepApplications 

. program define prepApplications
  1. syntax, [minYr(int 2004) maxYr(int 2017)]
  2. 
. 
.     use "$BUILD/magnet_rank.dta", clear
  3.         **In this case these are the same because we want to know who appl
> y to a magnet when they were in 5th year
.         gen endyear = school_yr
  4.     keep if choice_ranking ==1 
  5.     keep if endyear >=`minYr' & endyear <= `maxYr'
  6.     keep if stu_grade==6
  7. 
.     save $DTAFINAL/applications_5thgrade_cohorts_`minYr'_`maxYr'.dta, replace
  8. end 

. 
. 
. 
. /****************************************************************************
> ****
> * isolateSchools 
> * Description: There are many programs middle school students apply to that a
> re 
> * elementary programs or other highly gifted programs with additional screeni
> ng 
> * criteria. Drop these programs and keep only those that are middle school ma
> gnets. 
> * This will be the list of magnets that we use moving forward. 
> *****************************************************************************
> ***/
. capture program drop isolateSchools

. program define isolateSchools
  1. 
.     use $DTAFINAL/applications_5thgrade_cohorts_2004_2008.dta, clear 
  2.     drop if regexm(mag_name_ , "MS")
  3.     drop if regexm(mag_name_ , " EL") | regexm(mag_name_ , " CM") | regexm
> (mag_name_ , "ACAD")
  4.     drop if regexm(mag_name_ , " CA") | regexm(mag_name_ , " LC") | regexm
> (mag_name_ , "ACAD")
  5.     drop if regexm(mag_name_, "SVCS-CO")
  6.     drop if regexm(mag_name_, "CONTRACT ISSUED")
  7.     drop if regexm(mag_name_, "CHATSWORTH LAAMP")
  8.     gen obs = 1 
  9.     bys mag_cd_: egen numApps = total(obs)
 10.     tab numApps
 11.     keep if numApps>15
 12. 
.     bys endyear: egen nschools = nvals(mag_cd_ )
 13.     egen nschoolsall = nvals(mag_cd_ )
 14. 
.     tab nschools 
 15.     tab nschoolsall 
 16. 
.     * These magnets do not exist in enrollment data -- all are elementary sch
> ools
.     drop if mag_cd_== 1226901 | mag_cd_== 1493201 | mag_cd_== 1713702 | mag_c
> d_== 1861402 | mag_cd_== 1875401 | mag_cd == 1206802  
 17.     * The following are highly gifted and have other screening criteria 
.     drop if mag_cd == 1350702 | mag_cd == 1350703
 18. 
.     contract mag_cd_ mag_name_
 19.     
.     rename mag_cd_ schoolcostcentercode
 20.     drop _freq 
 21.  
.     save $DTAFINAL/magnet_codes_2004_2008.dta, replace
 22. end 

. 
. 
. capture program drop isolateApplications 

. program define isolateApplications
  1.     set sortseed 123456 
  2. 
.     use $DTAFINAL/applications_5thgrade_cohorts_2004_2008.dta, clear 
  3.     drop if regexm(mag_name_ , "MS")
  4.     drop if regexm(mag_name_ , " EL") | regexm(mag_name_ , " CM") | regexm
> (mag_name_ , "ACAD")
  5.     drop if regexm(mag_name_ , " CA") | regexm(mag_name_ , " LC") | regexm
> (mag_name_ , "ACAD")
  6. 
.     duplicates drop studentpseudoid endyear, force 
  7.     rename mag_cd_ schoolcostcentercode 
  8.     merge m:1 schoolcostcentercode using $DTAFINAL/magnet_codes_2004_2008.
> dta, gen(mergeMagnet) keep(3)
  9.     rename schoolcostcentercode mag_cd_
 10.     save $DTAFINAL/applications_2004_2008.dta, replace 
 11. 
.     gen offer = mag_action_=="B"
 12.     keep if offer ==1 
 13.     rename mag_cd_ mag_offered_code
 14.     keep studentpseudoid endyear mag_offered
 15.     duplicates drop studentpseudoid endyear, force
 16.     save $DTAFINAL/offers_2004_2008.dta, replace
 17. end 

. 
. 
. capture program drop calculateDistances 

. program define calculateDistances
  1. syntax, [cyear(string)]
  2. 
.         cap  log close 
  3. 
.         import delimited "$ROOTSOURCE/rawdata/raw_base/pubschls.csv", clear 
  4.         tempfile cde 
  5.         save `cde' 
  6. 
.         import delimited "$ROOTSOURCE/rawdata/raw_base/blocks_la.csv", clear 
> stringcols(_all) varnames(1)
  7.         destring lon lat, replace  float 
  8.         sort censusblockid 
  9.         gen blockid = _n 
 10.         count 
 11.         local Nblocks = r(N)
 12.         format lat %20.0g
 13.         format lon %20.0g
 14.         cap drop block_name
 15.         rename (lat lon) (block_lat block_lon)
 16.         tempfile blocks 
 17.         save `blocks'
 18.         
.         *2
. 
. 
.                 use if endyear>=2004 & endyear<=2008 using $RAWOUT/lausd2001_
> 2023_encoded.dta, clear 
 19.                 keep if gradecode==6 
 20.                 collapse (count) enrollment = endyear, by(preferredlocatio
> ncode schoolcostcentercode gradecode) 
 21.                 merge m:1 preferredlocationcode using "$ROOTSOURCE/rawdata
> /raw_base/plocn_cde_xwalk.dta", gen(mergeCDEcodes) keep(3) 
 22.                 * Four obs are unmatched (check website to manually assign
> )
.                 replace cdecode = 0140046 if preferredlocationcode==7895
 23.                 replace cdecode = 6058028 if preferredlocationcode==7567
 24.                 replace cdecode = 6057962 if preferredlocationcode==7566
 25.                 tostring cdecode , replace
 26.                 replace cdecode = "0" + cdecode if length(cdecode )==6
 27.                 replace cdecode = "1964733" + cdecode
 28.                 gen cdscode = cdecode
 29.                 merge m:1 cdscode using `cde', keep(1 3) gen(mergeCDEInfo)
 30. 
.         * Keep only magnet programs that we have flagged 
.         merge m:1 schoolcostcentercode using "$DTAFINAL/magnet_codes_2004_200
> 8.dta", gen(mergeMagnet) keep(3)
 31. 
.                 * create an alternate identifier to use in expand 
.                 *drop preferredlocationcode
.                 gen grade_level = gradecode 
 32.                 rename schoolcostcentercode school_number
 33.                 sort grade_level school_number
 34.                 bys grade_level: gen auxid = _n
 35. 
.                 * keep relevent variables to merge later 
.                 keep school_number  grade_level cdscode  latitude longitude  
 36.                 order  grade_level, after(school_number)
 37.                 foreach var of varlist cdscode latitude longitude {
 38.                         rename `var' receiving_`var'
 39.                 }
 40.                 gen feeder_grade = grade_level 
 41.                 replace grade_level = grade_level-1
 42. 
.                 * drop additional Special Ed, Continuation, Opportunity and a
> dult schools 
.                 *drop if inlist(receiving_edopsname, "Community Day School", 
> "Continuation School", "Opportunity School", "Special Education School")
.                 tempfile receiving_schools 
 43.                 drop if receiving_latitude=="No Data" | receiving_longitud
> e=="No Data"
 44.                 drop if receiving_latitude=="NA" | receiving_longitude=="N
> A"
 45.                 destring  receiving_latitude receiving_longitude , replace
>  
 46.                 save `receiving_schools' 
 47.                 
. 
.         use `receiving_schools', clear 
 48.         keep if grade_level==5
 49.         count 
 50.         
.         local Nexpand = r(N) 
 51.         expand `Nblocks'
 52.         sort school_number
 53.         bys school_number: gen blockid = _n 
 54.         merge m:1 blockid using `blocks', gen(mergeBlocks) 
 55.         geodist block_lat block_lon receiving_latitude receiving_longitude
> , gen(dist) miles  
 56.         sort censusblockid dist 
 57. 
.         * Identify magnet schools
. 
.         cap destring receiving_cdscode , replace
 58.         cap format receiving_cdscode %20.0g 
 59.         drop feeder_grade pop receiving_cdscode
 60.         
.         keep censusblockid block_lat block_lon dist school_number 
 61.         rename dist d_ 
 62.         reshape wide d_, i(censusblockid) j(school_number)
 63.         save $DTAFINAL/distance_to_magnets_2004_2008.dta, replace 
 64. 
. 
. 
. 
. end 

. 
. 
. 
. capture program drop prepStructuralData

. program define prepStructuralData
  1.         
. 
.         *AV 07/24/2025 when using the command getcensus i was getting a weird
>  error about the 
.         * directoy, this was my solution but may need to be adapted for diffe
> rent users
.         *! mkdir -p /home/avazque0/.local/share/getcensus/
.         *! ls -la /home/avazque0/.local/share/getcensus/
.         ***
.         getcensus B19013, geography(tract) sample(5) state("06") clear year(2
> 020)
  2.     gen censustract = state + county + tract 
  3.     rename b19013_001e median_income 
  4.     keep censustract median_income
  5.     replace median_income = 0 if missing(median_income)
  6.     replace median_income = median_income/10000
  7.     tempfile census_tracts
  8.     save `census_tracts', replace
  9. 
.     use $DTAFINAL/magnet_codes_2004_2008.dta, clear 
 10.     levelsof schoolcostcentercode, local(mag_codes) clean 
 11.     
. 
.     use $DTAFINAL/lausd_5thgrade_cohorts_2004_2008.dta, clear 
 12.     merge m:1 studentpseudoid endyear using $DTAFINAL/applications_2004_20
> 08.dta, keepusing(mag_cd_) gen(mergeApps) keep(1 3)
 13.     rename mag_cd_ mag_applied_code 
 14.     merge m:1 studentpseudoid endyear using $DTAFINAL/offers_2004_2008.dta
> , keepusing(mag_offered_code) gen(mergeOffers) keep(1 3)
 15.      * Organize the data in a particular order for the structural code 
.     local covs "female black white hispanic poverty el eng_home"
 16.     order endyear `covs', first 
 17.     local scores "F1math F1ela F2math F2ela F3math F3ela avg_Fmath avg_Fel
> a"
 18.     order `scores', after(eng_home)
 19.     rename (z_math_all z_ela_all) (lag_math lag_ela)
 20.     bys endyear: egen mean_math = mean(lag_math)
 21.     bys endyear: egen mean_ela = mean(lag_ela)
 22.     replace lag_math = lag_math - mean_math
 23.     replace lag_ela = lag_ela - mean_ela
 24.     gen missing_math = missing(lag_math)
 25.     gen missing_ela = missing(lag_ela)
 26. 
.     replace lag_math = 0 if missing_math == 1
 27.     replace lag_ela = 0 if missing_ela == 1
 28.     local lags "lag_math lag_ela missing_math missing_ela"
 29.     order `lags', after(avg_Fela)
 30. 
.     gen Dchoice = next_scode 
 31.     order Dchoice, after(missing_ela)
 32. 
.     * Create enrollment and application dummies 
.     foreach code of local mag_codes{
 33.         gen D_`code' = next_scode == `code'
 34.     }
 35.     foreach code of local mag_codes{
 36.         gen A_`code' = mag_applied_code == `code'
 37.     }
 38.     foreach code of local mag_codes{
 39.         gen Z_`code' = mag_offered_code == `code'
 40.     }
 41.     gen Achoice= mag_applied_code
 42.     replace Achoice = 0 if missing(Achoice)
 43. 
. 
.     egen enroll_one = rowtotal(D_*)
 44.     gen D_0 = enroll_one ==0 
 45.     drop enroll_one
 46.     
.     order Achoice, after(Dchoice)
 47.     order D_* A_* Z_*, after(Dchoice)
 48.     order D_0, after(Dchoice)
 49. 
.     * Keep students with addresses 
.     merge m:1 censusblockid using $DTAFINAL/distance_to_magnets_2004_2008.dta
> , gen(mergeDistance) keep(3)
 50. 
.     order d_*, after(Z_1884201)
 51.     foreach code of local mag_codes{
 52.         replace d_`code' = d_`code' - nearest_schl_dist
 53.     }
 54. 
.     order block_lat block_lon, after(d_1884201)
 55. 
.     drop if missing(avg_Fela) | missing(avg_Fmath)
 56. 
.      * DROP STUDENTS WHO ENROLLED IN A SCHOOL THEY DIDN'T RECEIVE AN OFFER FR
> OM
.     gen inconsistent_enrollment = 0
 57.     foreach code of local mag_codes {
 58.         replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' ==
>  0
 59.     }
 60.     count if inconsistent_enrollment == 1
 61.     local dropped = r(N)
 62.     drop if inconsistent_enrollment == 1
 63.     drop inconsistent_enrollment
 64.     display "Dropped `dropped' students who enrolled in schools they didn'
> t receive offers from"
 65. 
. 
.     drop studentclassofname esp_home ytdofattendeddays ytdofenrolleddays ytdo
> fabsentdays otherabsencecount ytdofattendance appabsencecount mergeATT num_of
> _suspensions_Class num_suspended_days_Class num_of_suspensions_In_school num_
> suspended_days_In_school num_of_suspensions_Out_of_school num_suspended_days_
> Out_of_school total_num_suspended_days total_num_suspensions mergeSuspensions
>  gpa_fall gpa_spring mergeGPA
 66. 
.     drop mergeAFC mergeMagnet mergeDLE mergeACS mergePWT mergeSAS cst_ela cst
> _math z_cst_ela z_cst_math z_sbac_ela z_sbac_math
 67.     
.     
.     gen censustract = substr(censusblockid, 1, 11) 
 68.     merge m:1 censustract using `census_tracts', gen(mergeCensus) keep(1 3
> )
 69. 
.     gen any_missing_score = missing_math==1 | missing_ela ==1
 70.     gen current_in_mag = regexm(sname, "MAG") | regexm(sname, "MG") | rege
> xm(sname, "SOCES") | regexm(sname, "LACES")
 71.     bys sname endyear : egen current_peer_quality =mean(lag_math)
 72.     
.     * For now have a subset of applicants that apply to magnets that we have 
> not flagged as magnets (3%)
.     * Drop for now 
.     gen applied = Achoice !=0
 73.     drop if applied==0 & appliedMagnet==1
 74. 
.     sort endyear studentpseudoid
 75.     save $DTAFINAL/structural_data_2004_2008.dta, replace
 76. 
.     gen rand = runiform()
 77.     sort rand 
 78.     keep if rand <=0.25
 79.     drop rand 
 80.     sort endyear studentpseudoid
 81.     save $DTAFINAL/structural_data_2004_2008_sample.dta, replace
 82. 
. end 

. 
. 
. 
. capture program drop prepareSeats

. program define prepareSeats 
  1. 
.     use $BUILD/magnet_cutoffs/prog_seats_app.dta, clear 
  2.     rename mag_cd_ schoolcostcentercode 
  3.     rename app_endyear endyear
  4.     keep if endyear <=2008 & endyear>=2004
  5.     keep if stu_grade==6 
  6. 
.     merge m:1 schoolcostcentercode using $DTAFINAL/magnet_codes_2004_2008.dta
> , gen(mergeSchools) keep(3)
  7.     preserve 
  8.         keep endyear schoolcostcentercode stu_grade phbao seats_available
  9.         rename seats_available seats_ 
 10.         reshape wide seats_, i(endyear stu_grade phbao) j(schoolcostcenter
> code)
 11.         ds seats_*
 12.         foreach var of varlist `r(varlist)'{
 13.             replace `var' = 0 if missing(`var')
 14.         }
 15.         save $DTAFINAL/prog_seats_2004_2008.dta, replace
 16.     restore
 17.     preserve 
 18.         collapse (sum) applications seats_available, by(schoolcostcenterco
> de)
 19.         gen p = seats_available / applications
 20.         replace p = 1 if seats_available> applications & !missing(seats_av
> ailable)
 21.         save $DTAFINAL/aggregate_prog_admission_prob_2004_2008.dta, replac
> e
 22.     restore 
 23.     gen p_i = seats_available /applications 
 24.     replace p_i = 1 if seats_available> applications & !missing(seats_avai
> lable)
 25.     replace p_i = 0 if missing(p_i)
 26.     
. 
.     keep endyear schoolcostcentercode stu_grade phbao p_i
 27. 
.     rename p_i p_i_
 28.     reshape wide p_i_ , i(endyear stu_grade phbao ) j(schoolcostcentercode
>  )
 29.     ds p_i_*
 30.     foreach var of varlist `r(varlist)'{
 31.         replace `var' = 0 if missing(`var')
 32.     }
 33.     save $DTAFINAL/prog_seats_app_2004_2008.dta, replace
 34. 
. end 

. 
. 
. capture program drop student_p_i 

. program define student_p_i 
  1. 
.     use $DTAFINAL/structural_data_2004_2008.dta, clear
  2.     gen phbao = (black==1 | asian==1 | hispanic==1 | other==1)
  3.     gen stu_grade = 6 
  4.     merge m:1 phbao stu_grade endyear using $DTAFINAL/prog_seats_app_2004_
> 2008.dta, gen(mergeP) keep( 1 3)
  5.     sort endyear studentpseudoid
  6.     keep studentpseudoid endyear p_i_*
  7. 
.     save $DTAFINAL/student_p_i_2004_2008.dta, replace
  8. 
.     use $DTAFINAL/structural_data_2004_2008_sample.dta, clear
  9.     gen phbao = (black==1 | asian==1 | hispanic==1 | other==1)
 10.     gen stu_grade = 6 
 11.     merge m:1 phbao stu_grade endyear using $DTAFINAL/prog_seats_app_2004_
> 2008.dta, gen(mergeP) keep(1 3)
 12.     sort endyear studentpseudoid
 13.     keep studentpseudoid endyear p_i_*
 14.     save $DTAFINAL/student_p_i_2004_2008_sample.dta, replace
 15. end 

. 
. 
. main
  -------------------------------------------------------------- begin main ---
  - set_paths
    ------------------------------------------------------- begin set_paths ---
    - if "`c(os)'"=="MacOSX" & "`c(username)'"=="cqcampos"{
    = if "Unix"=="MacOSX" & "ryanlee22"=="cqcampos"{
      global ROOT /Volumes/lausd/decentralized_choice
      global BUILD /Volumes/lausd/build/output/data
      global ROOTSOURCE "/Volumes/lausd/build/"
      global magnet "/Volumes/lausd/magnet/"
      }
    - else{
    - global ROOT "/project/lausd/decentralized_choice"
    - global BUILD "/project/lausd/build/output/data"
    - global ROOTSOURCE "/project/lausd/build/"
    - global magnet "/project/lausd/magnet"
    - }
    - global DTARAW "$ROOT/rawdata"
    = global DTARAW "/project/lausd/decentralized_choice/rawdata"
    - global RAW $ROOT/data/raw
    = global RAW /project/lausd/decentralized_choice/data/raw
    - global DTAFINAL "$ROOT/data"
    = global DTAFINAL "/project/lausd/decentralized_choice/data"
    - global tables "$ROOT/tables"
    = global tables "/project/lausd/decentralized_choice/tables"
    - global figures "$ROOT/figures"
    = global figures "/project/lausd/decentralized_choice/figures"
    - global UE "$ROOTSOURCE/rawdata/Campos_Master_DUA/Unified_Enrollment"
    = global UE "/project/lausd/build//rawdata/Campos_Master_DUA/Unified_Enroll
> ment"
    - global RAWOUT "$ROOTSOURCE/output/data"
    = global RAWOUT "/project/lausd/build//output/data"
    --------------------------------------------------------- end set_paths ---
  - prepStudentData, minYr(2004) maxYr(2008)
    ------------------------------------------------- begin prepStudentData ---
    - syntax, [minYr(int 2004) maxYr(int 2017)]
    - use if endyear >=`minYr' & endyear <=(`maxYr' +1) using $RAWOUT/lausd2001
> _2023_encoded.dta, clear
    = use if endyear >=2004 & endyear <=(2008 +1) using /project/lausd/build//o
> utput/data/lausd2001_2023_encoded.dta, clear
    - merge m:1 studentpseudoid endyear using $RAW/magnet_offers, gen(mergeOffe
> rs) keep( 1 3)
    = merge m:1 studentpseudoid endyear using /project/lausd/decentralized_choi
> ce/data/raw/magnet_offers, gen(mergeOffers) keep( 1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                     3,770,234
        from master                 3,770,234  (mergeOffers==1)
        from using                          0  (mergeOffers==2)

    Matched                           268,145  (mergeOffers==3)
    -----------------------------------------
    - drop mergeOffers
    - gen appliedMagnet = mergeMagnet ==3
    - egen sid = group(studentpseudoid)
    - xtset sid endyear

Panel variable: sid (unbalanced)
 Time variable: endyear, 2004 to 2009, but with gaps
         Delta: 1 unit
    - decode schoollocationname, gen(sname)
    - gen next_schoolname = F1.schoollocationname
(1,179,678 missing values generated)
    - label values next_schoolname schoollocationname_
    - gen next_scode = F1.schoolcostcentercode
(1,204,716 missing values generated)
    - decode next_schoolname, gen(next_sname)
    - gen F1math = F1.z_math_all
(1,988,461 missing values generated)
    - gen F1ela = F1.z_ela_all
(1,845,736 missing values generated)
    - gen F2math = F2.z_math_all
(2,589,751 missing values generated)
    - gen F2ela = F2.z_ela_all
(2,477,325 missing values generated)
    - gen F3math = F3.z_math_all
(3,110,046 missing values generated)
    - gen F3ela = F3.z_ela_all
(3,031,160 missing values generated)
    - egen avg_Fmath = rowmean(F1math F2math F3math)
(1,766,782 missing values generated)
    - egen avg_Fela = rowmean(F1ela F2ela F3ela)
(1,661,764 missing values generated)
    - gen hispanic = ethnicitydescription==1
    - gen black = ethnicitydescription==2
    - gen white = ethnicitydescription==3
    - gen asian= ethnicitydescription==4
    - gen other = hispanic==0 & black==0 & white==0 & asian==0
    - gen female = gendercode==1
    - gen poverty = studentpovertyindicator==3
    - gen el = languageclasscode==3
    - gen gifted = !missing(studentgiftedprogramdescription)
    - gen sixthGradeAddress = censusblockid1 if gradecode ==6
(3,723,908 missing values generated)
    - bys studentpseudoid : egen addressSix = mean(sixthGradeAddress )
(2,408,111 missing values generated)
    - replace censusblockid1 = addressSix if missing(censusblockid1 ) & gradeco
> de ==5
variable censusblockid1 was long now double
(201,204 real changes made)
    - keep if gradecode==5
(3,686,373 observations deleted)
    - gen schooltype = "ms" if gradecode ==5
    - rename censusblockid1 censusblockid
    - decode censusblockid, gen(blockid)
    - rename (censusblockid blockid) (blockid censusblockid)
    - merge m:1 censusblockid schooltype endyear using $DTAFINAL/intermediate/m
> agnet_distances.dta , gen(mergeDistances) keep(1 3)
    = merge m:1 censusblockid schooltype endyear using /project/lausd/decentral
> ized_choice/data/intermediate/magnet_distances.dta , gen(mergeDistances) keep
> (1 3)
(variable schooltype was str2, now str3 to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       100,345
        from master                   100,345  (mergeDistances==1)
        from using                          0  (mergeDistances==2)

    Matched                           251,661  (mergeDistances==3)
    -----------------------------------------
    - gen next_mag = regexm(next_sname , "MAG") | regexm(next_sname, "MG")
    - drop city2 api_city2 api_state2 api_zip_code2 censusblockid2 city3 api_ci
> ty3 api_state3 api_zip_code3 censusblockid3 city4 api_city4 api_state4 api_zi
> p_code4 censusblockid4 city5 api_city5 api_state5 api_zip_code5 censusblockid
> 5 city6 api_city6 api_state6 api_zip_code6 censusblockid6 city7 api_city7 api
> _state7 api_zip_code7 censusblockid7 city8 api_city8 api_state8 api_zip_code8
>  censusblockid8 city9 api_city9 api_state9 api_zip_code9 censusblockid9 sbac_
> ela sbac_math mergeSBAC ss_cst_ela1 ss_cst_math1 ss_cst_ela2 ss_cst_math2 num
> Tests testid mergeCST effective_date2 zip_code2 effective_date3 zip_code3 eff
> ective_date4 zip_code4 effective_date5 zip_code5 effective_date6 zip_code6 ef
> fective_date7 zip_code7 effective_date8 zip_code8 effective_date9 zip_code9 m
> ergeAddresses ethnicitydescription gendercode parentedulevelname preferredloc
> ationname schoollocationname studentbirthcountry studentusschoolfirstattendda
> te languageclasscode homelanguagedescription studentspedflag studentgiftedpro
> gramdescription studentpovertyindicator overallperformancelevelnameELA overal
> lperformancelevelnameMath testnameela1 testnamemath1 testnameela2 testnamemat
> h2 perf_cst_ela1 perf_cst_math1 perf_cst_ela2 perf_cst_math2 sixthGradeAddres
> s addressSix
    - save $DTAFINAL/lausd_5thgrade_cohorts_`minYr'_`maxYr'.dta, replace
    = save /project/lausd/decentralized_choice/data/lausd_5thgrade_cohorts_2004
> _2008.dta, replace
file
    /project/lausd/decentralized_choice/data/lausd_5thgrade_cohorts_2004_2008
    > .dta saved
    --------------------------------------------------- end prepStudentData ---
  - prepApplications, minYr(2004) maxYr(2008)
    ------------------------------------------------ begin prepApplications ---
    - syntax, [minYr(int 2004) maxYr(int 2017)]
    - use "$BUILD/magnet_rank.dta", clear
    = use "/project/lausd/build/output/data/magnet_rank.dta", clear
    - gen endyear = school_yr
    - keep if choice_ranking ==1
(2,380,044 observations deleted)
    - keep if endyear >=`minYr' & endyear <= `maxYr'
    = keep if endyear >=2004 & endyear <= 2008
(930,096 observations deleted)
    - keep if stu_grade==6
(211,432 observations deleted)
    - save $DTAFINAL/applications_5thgrade_cohorts_`minYr'_`maxYr'.dta, replace
    = save /project/lausd/decentralized_choice/data/applications_5thgrade_cohor
> ts_2004_2008.dta, replace
file
    /project/lausd/decentralized_choice/data/applications_5thgrade_cohorts_20
    > 04_2008.dta saved
    -------------------------------------------------- end prepApplications ---
  - isolateSchools
    -------------------------------------------------- begin isolateSchools ---
    - use $DTAFINAL/applications_5thgrade_cohorts_2004_2008.dta, clear
    = use /project/lausd/decentralized_choice/data/applications_5thgrade_cohort
> s_2004_2008.dta, clear
    - drop if regexm(mag_name_ , "MS")
(8,401 observations deleted)
    - drop if regexm(mag_name_ , " EL") | regexm(mag_name_ , " CM") | regexm(ma
> g_name_ , "ACAD")
(11 observations deleted)
    - drop if regexm(mag_name_ , " CA") | regexm(mag_name_ , " LC") | regexm(ma
> g_name_ , "ACAD")
(8 observations deleted)
    - drop if regexm(mag_name_, "SVCS-CO")
(1 observation deleted)
    - drop if regexm(mag_name_, "CONTRACT ISSUED")
(1 observation deleted)
    - drop if regexm(mag_name_, "CHATSWORTH LAAMP")
(1 observation deleted)
    - gen obs = 1
    - bys mag_cd_: egen numApps = total(obs)
    - tab numApps

    numApps |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         16        0.04        0.04
          2 |         28        0.07        0.11
          3 |         24        0.06        0.17
          4 |         44        0.11        0.28
          5 |         45        0.11        0.39
          6 |         54        0.13        0.53
          7 |          7        0.02        0.54
          8 |         16        0.04        0.58
          9 |         27        0.07        0.65
         10 |         10        0.02        0.68
         11 |         11        0.03        0.70
         12 |         36        0.09        0.79
         13 |         13        0.03        0.83
         18 |         18        0.04        0.87
         21 |         21        0.05        0.92
         24 |         24        0.06        0.98
         25 |         25        0.06        1.05
         32 |         32        0.08        1.13
         46 |         46        0.11        1.24
         59 |         59        0.15        1.39
        239 |        239        0.60        1.98
        249 |        249        0.62        2.61
        250 |        250        0.62        3.23
        267 |        267        0.67        3.90
        280 |        280        0.70        4.59
        308 |        308        0.77        5.36
        337 |        337        0.84        6.20
        350 |        350        0.87        7.08
        359 |        359        0.90        7.97
        360 |        360        0.90        8.87
        361 |        361        0.90        9.77
        386 |        386        0.96       10.74
        392 |        392        0.98       11.71
        405 |        405        1.01       12.72
        500 |        500        1.25       13.97
        521 |        521        1.30       15.27
        552 |        552        1.38       16.65
        585 |        585        1.46       18.11
        620 |        620        1.55       19.66
        642 |        642        1.60       21.26
        647 |        647        1.61       22.87
        664 |        664        1.66       24.53
        693 |        693        1.73       26.26
        768 |        768        1.92       28.18
        771 |        771        1.92       30.10
        861 |        861        2.15       32.25
        867 |        867        2.16       34.41
        887 |        887        2.21       36.63
        888 |        888        2.22       38.84
       1053 |      1,053        2.63       41.47
       1157 |      1,157        2.89       44.36
       1202 |      1,202        3.00       47.36
       1261 |      1,261        3.15       50.51
       1343 |      1,343        3.35       53.86
       1788 |      1,788        4.46       58.32
       2014 |      2,014        5.03       63.35
       2139 |      2,139        5.34       68.68
       2247 |      2,247        5.61       74.29
       2290 |      2,290        5.71       80.01
       3429 |      3,429        8.56       88.56
       4583 |      4,583       11.44      100.00
------------+-----------------------------------
      Total |     40,071      100.00
    - keep if numApps>15
(331 observations deleted)
    - bys endyear: egen nschools = nvals(mag_cd_ )
    - egen nschoolsall = nvals(mag_cd_ )
    - tab nschools

   nschools |      Freq.     Percent        Cum.
------------+-----------------------------------
         48 |     39,740      100.00      100.00
------------+-----------------------------------
      Total |     39,740      100.00
    - tab nschoolsall

nschoolsall |      Freq.     Percent        Cum.
------------+-----------------------------------
         48 |     39,740      100.00      100.00
------------+-----------------------------------
      Total |     39,740      100.00
    - drop if mag_cd_== 1226901 | mag_cd_== 1493201 | mag_cd_== 1713702 | mag_c
> d_== 1861402 | mag_cd_== 1875401 | mag_cd == 1206802
(166 observations deleted)
    - drop if mag_cd == 1350702 | mag_cd == 1350703
(326 observations deleted)
    - contract mag_cd_ mag_name_
    - rename mag_cd_ schoolcostcentercode
    - drop _freq
    - save $DTAFINAL/magnet_codes_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/magnet_codes_2004_2008.dta,
>  replace
file /project/lausd/decentralized_choice/data/magnet_codes_2004_2008.dta
    saved
    ---------------------------------------------------- end isolateSchools ---
  - isolateApplications
    --------------------------------------------- begin isolateApplications ---
    - set sortseed 123456
    - use $DTAFINAL/applications_5thgrade_cohorts_2004_2008.dta, clear
    = use /project/lausd/decentralized_choice/data/applications_5thgrade_cohort
> s_2004_2008.dta, clear
    - drop if regexm(mag_name_ , "MS")
(8,401 observations deleted)
    - drop if regexm(mag_name_ , " EL") | regexm(mag_name_ , " CM") | regexm(ma
> g_name_ , "ACAD")
(11 observations deleted)
    - drop if regexm(mag_name_ , " CA") | regexm(mag_name_ , " LC") | regexm(ma
> g_name_ , "ACAD")
(8 observations deleted)
    - duplicates drop studentpseudoid endyear, force

Duplicates in terms of studentpseudoid endyear

(148 observations deleted)
    - rename mag_cd_ schoolcostcentercode
    - merge m:1 schoolcostcentercode using $DTAFINAL/magnet_codes_2004_2008.dta
> , gen(mergeMagnet) keep(3)
    = merge m:1 schoolcostcentercode using /project/lausd/decentralized_choice/
> data/magnet_codes_2004_2008.dta, gen(mergeMagnet) keep(3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            39,104  (mergeMagnet==3)
    -----------------------------------------
    - rename schoolcostcentercode mag_cd_
    - save $DTAFINAL/applications_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/applications_2004_2008.dta,
>  replace
file /project/lausd/decentralized_choice/data/applications_2004_2008.dta
    saved
    - gen offer = mag_action_=="B"
    - keep if offer ==1
(22,458 observations deleted)
    - rename mag_cd_ mag_offered_code
    - keep studentpseudoid endyear mag_offered
    - duplicates drop studentpseudoid endyear, force

Duplicates in terms of studentpseudoid endyear

(0 observations are duplicates)
    - save $DTAFINAL/offers_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/offers_2004_2008.dta, repla
> ce
file /project/lausd/decentralized_choice/data/offers_2004_2008.dta saved
    ----------------------------------------------- end isolateApplications ---
  - calculateDistances
    ---------------------------------------------- begin calculateDistances ---
    - syntax, [cyear(string)]
    - cap log close
    - import delimited "$ROOTSOURCE/rawdata/raw_base/pubschls.csv", clear
    = import delimited "/project/lausd/build//rawdata/raw_base/pubschls.csv", c
> lear
(encoding automatically selected: ISO-8859-1)
(48 vars, 18,269 obs)
    - tempfile cde
    - save `cde'
    = save /scratch/ryanlee22/15095981/St1456097.000002
file /scratch/ryanlee22/15095981/St1456097.000002 saved as .dta format
    - import delimited "$ROOTSOURCE/rawdata/raw_base/blocks_la.csv", clear stri
> ngcols(_all) varnames(1)
    = import delimited "/project/lausd/build//rawdata/raw_base/blocks_la.csv", 
> clear stringcols(_all) varnames(1)
(encoding automatically selected: ISO-8859-1)
(5 vars, 91,626 obs)
    - destring lon lat, replace float
lon: all characters numeric; replaced as float
lat: all characters numeric; replaced as float
    - sort censusblockid
    - gen blockid = _n
    - count
  91,626
    - local Nblocks = r(N)
    - format lat %20.0g
    - format lon %20.0g
    - cap drop block_name
    - rename (lat lon) (block_lat block_lon)
    - tempfile blocks
    - save `blocks'
    = save /scratch/ryanlee22/15095981/St1456097.000003
file /scratch/ryanlee22/15095981/St1456097.000003 saved as .dta format
    - use if endyear>=2004 & endyear<=2008 using $RAWOUT/lausd2001_2023_encoded
> .dta, clear
    = use if endyear>=2004 & endyear<=2008 using /project/lausd/build//output/d
> ata/lausd2001_2023_encoded.dta, clear
    - keep if gradecode==6
(3,136,960 observations deleted)
    - collapse (count) enrollment = endyear, by(preferredlocationcode schoolcos
> tcentercode gradecode)
    - merge m:1 preferredlocationcode using "$ROOTSOURCE/rawdata/raw_base/plocn
> _cde_xwalk.dta", gen(mergeCDEcodes) keep(3)
    = merge m:1 preferredlocationcode using "/project/lausd/build//rawdata/raw_
> base/plocn_cde_xwalk.dta", gen(mergeCDEcodes) keep(3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               195  (mergeCDEcodes==3)
    -----------------------------------------
    - replace cdecode = 0140046 if preferredlocationcode==7895
(0 real changes made)
    - replace cdecode = 6058028 if preferredlocationcode==7567
(0 real changes made)
    - replace cdecode = 6057962 if preferredlocationcode==7566
(0 real changes made)
    - tostring cdecode , replace
cdecode was long now str7
    - replace cdecode = "0" + cdecode if length(cdecode )==6
(9 real changes made)
    - replace cdecode = "1964733" + cdecode
variable cdecode was str7 now str14
(195 real changes made)
    - gen cdscode = cdecode
    - merge m:1 cdscode using `cde', keep(1 3) gen(mergeCDEInfo)
    = merge m:1 cdscode using /scratch/ryanlee22/15095981/St1456097.000002, kee
> p(1 3) gen(mergeCDEInfo)
(variable cdscode was str14, now str16 to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               195  (mergeCDEInfo==3)
    -----------------------------------------
    - merge m:1 schoolcostcentercode using "$DTAFINAL/magnet_codes_2004_2008.dt
> a", gen(mergeMagnet) keep(3)
    = merge m:1 schoolcostcentercode using "/project/lausd/decentralized_choice
> /data/magnet_codes_2004_2008.dta", gen(mergeMagnet) keep(3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                40  (mergeMagnet==3)
    -----------------------------------------
    - gen grade_level = gradecode
    - rename schoolcostcentercode school_number
    - sort grade_level school_number
    - bys grade_level: gen auxid = _n
    - keep school_number grade_level cdscode latitude longitude
    - order grade_level, after(school_number)
    - foreach var of varlist cdscode latitude longitude {
    - rename `var' receiving_`var'
    = rename cdscode receiving_cdscode
    - }
    - rename `var' receiving_`var'
    = rename latitude receiving_latitude
    - }
    - rename `var' receiving_`var'
    = rename longitude receiving_longitude
    - }
    - gen feeder_grade = grade_level
    - replace grade_level = grade_level-1
(40 real changes made)
    - tempfile receiving_schools
    - drop if receiving_latitude=="No Data" | receiving_longitude=="No Data"
(0 observations deleted)
    - drop if receiving_latitude=="NA" | receiving_longitude=="NA"
(0 observations deleted)
    - destring receiving_latitude receiving_longitude , replace
receiving_latitude: all characters numeric; replaced as double
receiving_longitude: all characters numeric; replaced as double
    - save `receiving_schools'
    = save /scratch/ryanlee22/15095981/St1456097.000004
file /scratch/ryanlee22/15095981/St1456097.000004 saved as .dta format
    - use `receiving_schools', clear
    = use /scratch/ryanlee22/15095981/St1456097.000004, clear
    - keep if grade_level==5
(0 observations deleted)
    - count
  40
    - local Nexpand = r(N)
    - expand `Nblocks'
    = expand 91626
(3,665,000 observations created)
    - sort school_number
    - bys school_number: gen blockid = _n
    - merge m:1 blockid using `blocks', gen(mergeBlocks)
    = merge m:1 blockid using /scratch/ryanlee22/15095981/St1456097.000003, gen
> (mergeBlocks)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         3,665,040  (mergeBlocks==3)
    -----------------------------------------
    - geodist block_lat block_lon receiving_latitude receiving_longitude, gen(d
> ist) miles
    - sort censusblockid dist
    - cap destring receiving_cdscode , replace
    - cap format receiving_cdscode %20.0g
    - drop feeder_grade pop receiving_cdscode
    - keep censusblockid block_lat block_lon dist school_number
    - rename dist d_
    - reshape wide d_, i(censusblockid) j(school_number)
(j = 1331101 1350001 1713701 1739001 1802802 1803802 1804702 1804703 1806002 18
> 07502 1808002 1810302 1810702 1811002 1811202 1811802 1811803 1812702 1813702
>  1815102 1816802 1817902 1818202 1820802 1821702 1822602 1823502 1823702 1825
> 502 1827202 1832102 1832103 1835202 1835402 1835602 1836302 1838702 1849302 1
> 874101 1884201)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations        3,665,040   ->   91,626      
Number of variables                   5   ->   43          
j variable (40 values)    school_number   ->   (dropped)
xij variables:
                                     d_   ->   d_1331101 d_1350001 ... d_188420
> 1
-----------------------------------------------------------------------------
    - save $DTAFINAL/distance_to_magnets_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/distance_to_magnets_2004_20
> 08.dta, replace
file
    /project/lausd/decentralized_choice/data/distance_to_magnets_2004_2008.dt
    > a saved
    ------------------------------------------------ end calculateDistances ---
  - prepStructuralData
    ---------------------------------------------- begin prepStructuralData ---
    - getcensus B19013, geography(tract) sample(5) state("06") clear year(2020)
You have not provided an API key. Without a key, you are limited to 500 API
queries per day. To use an API key, specify key() or store your API key in a
global macro named censuskey in your profile.do.
(11 vars, 9,129 obs)
 Link to data for 2020
Variables labeled using data dictionary for 2020.
One or more variable labels were truncated. For full descriptions, list the
variable notes.
    - gen censustract = state + county + tract
    - rename b19013_001e median_income
    - keep censustract median_income
    - replace median_income = 0 if missing(median_income)
(127 real changes made)
    - replace median_income = median_income/10000
variable median_income was long now double
(9,002 real changes made)
    - tempfile census_tracts
    - save `census_tracts', replace
    = save /scratch/ryanlee22/15095981/St1456097.000002, replace
(file /scratch/ryanlee22/15095981/St1456097.000002 not found)
file /scratch/ryanlee22/15095981/St1456097.000002 saved as .dta format
    - use $DTAFINAL/magnet_codes_2004_2008.dta, clear
    = use /project/lausd/decentralized_choice/data/magnet_codes_2004_2008.dta, 
> clear
    - levelsof schoolcostcentercode, local(mag_codes) clean
1331101 1350001 1713701 1739001 1802802 1803802 1804702 1804703 1806002 1807502
>  1808002 1810302 1810702 1811002 1811202 1811802 1811803 1812702 1813702 1815
> 102 1816802 1817902 1818202 1820802 1821702 1822602 1823502 1823702 1825502 1
> 827202 1832102 1832103 1835202 1835402 1835602 1836302 1838702 1849302 187410
> 1 1884201
    - use $DTAFINAL/lausd_5thgrade_cohorts_2004_2008.dta, clear
    = use /project/lausd/decentralized_choice/data/lausd_5thgrade_cohorts_2004_
> 2008.dta, clear
    - merge m:1 studentpseudoid endyear using $DTAFINAL/applications_2004_2008.
> dta, keepusing(mag_cd_) gen(mergeApps) keep(1 3)
    = merge m:1 studentpseudoid endyear using /project/lausd/decentralized_choi
> ce/data/applications_2004_2008.dta, keepusing(mag_cd_) gen(mergeApps) keep(1 
> 3)
(label _merge already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       315,141
        from master                   315,141  (mergeApps==1)
        from using                          0  (mergeApps==2)

    Matched                            36,865  (mergeApps==3)
    -----------------------------------------
    - rename mag_cd_ mag_applied_code
    - merge m:1 studentpseudoid endyear using $DTAFINAL/offers_2004_2008.dta, k
> eepusing(mag_offered_code) gen(mergeOffers) keep(1 3)
    = merge m:1 studentpseudoid endyear using /project/lausd/decentralized_choi
> ce/data/offers_2004_2008.dta, keepusing(mag_offered_code) gen(mergeOffers) ke
> ep(1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       335,900
        from master                   335,900  (mergeOffers==1)
        from using                          0  (mergeOffers==2)

    Matched                            16,106  (mergeOffers==3)
    -----------------------------------------
    - local covs "female black white hispanic poverty el eng_home"
    - order endyear `covs', first
    = order endyear female black white hispanic poverty el eng_home, first
    - local scores "F1math F1ela F2math F2ela F3math F3ela avg_Fmath avg_Fela"
    - order `scores', after(eng_home)
    = order F1math F1ela F2math F2ela F3math F3ela avg_Fmath avg_Fela, after(en
> g_home)
    - rename (z_math_all z_ela_all) (lag_math lag_ela)
    - bys endyear: egen mean_math = mean(lag_math)
    - bys endyear: egen mean_ela = mean(lag_ela)
    - replace lag_math = lag_math - mean_math
(293,850 real changes made)
    - replace lag_ela = lag_ela - mean_ela
(314,469 real changes made)
    - gen missing_math = missing(lag_math)
    - gen missing_ela = missing(lag_ela)
    - replace lag_math = 0 if missing_math == 1
(37,017 real changes made)
    - replace lag_ela = 0 if missing_ela == 1
(37,470 real changes made)
    - local lags "lag_math lag_ela missing_math missing_ela"
    - order `lags', after(avg_Fela)
    = order lag_math lag_ela missing_math missing_ela, after(avg_Fela)
    - gen Dchoice = next_scode
(89,336 missing values generated)
    - order Dchoice, after(missing_ela)
    - foreach code of local mag_codes{
    - gen D_`code' = next_scode == `code'
    = gen D_1331101 = next_scode == 1331101
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1350001 = next_scode == 1350001
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1713701 = next_scode == 1713701
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1739001 = next_scode == 1739001
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1802802 = next_scode == 1802802
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1803802 = next_scode == 1803802
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1804702 = next_scode == 1804702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1804703 = next_scode == 1804703
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1806002 = next_scode == 1806002
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1807502 = next_scode == 1807502
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1808002 = next_scode == 1808002
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1810302 = next_scode == 1810302
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1810702 = next_scode == 1810702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1811002 = next_scode == 1811002
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1811202 = next_scode == 1811202
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1811802 = next_scode == 1811802
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1811803 = next_scode == 1811803
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1812702 = next_scode == 1812702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1813702 = next_scode == 1813702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1815102 = next_scode == 1815102
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1816802 = next_scode == 1816802
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1817902 = next_scode == 1817902
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1818202 = next_scode == 1818202
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1820802 = next_scode == 1820802
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1821702 = next_scode == 1821702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1822602 = next_scode == 1822602
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1823502 = next_scode == 1823502
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1823702 = next_scode == 1823702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1825502 = next_scode == 1825502
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1827202 = next_scode == 1827202
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1832102 = next_scode == 1832102
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1832103 = next_scode == 1832103
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1835202 = next_scode == 1835202
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1835402 = next_scode == 1835402
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1835602 = next_scode == 1835602
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1836302 = next_scode == 1836302
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1838702 = next_scode == 1838702
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1849302 = next_scode == 1849302
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1874101 = next_scode == 1874101
    - }
    - gen D_`code' = next_scode == `code'
    = gen D_1884201 = next_scode == 1884201
    - }
    - foreach code of local mag_codes{
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1331101 = mag_applied_code == 1331101
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1350001 = mag_applied_code == 1350001
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1713701 = mag_applied_code == 1713701
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1739001 = mag_applied_code == 1739001
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1802802 = mag_applied_code == 1802802
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1803802 = mag_applied_code == 1803802
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1804702 = mag_applied_code == 1804702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1804703 = mag_applied_code == 1804703
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1806002 = mag_applied_code == 1806002
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1807502 = mag_applied_code == 1807502
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1808002 = mag_applied_code == 1808002
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1810302 = mag_applied_code == 1810302
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1810702 = mag_applied_code == 1810702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1811002 = mag_applied_code == 1811002
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1811202 = mag_applied_code == 1811202
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1811802 = mag_applied_code == 1811802
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1811803 = mag_applied_code == 1811803
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1812702 = mag_applied_code == 1812702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1813702 = mag_applied_code == 1813702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1815102 = mag_applied_code == 1815102
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1816802 = mag_applied_code == 1816802
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1817902 = mag_applied_code == 1817902
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1818202 = mag_applied_code == 1818202
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1820802 = mag_applied_code == 1820802
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1821702 = mag_applied_code == 1821702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1822602 = mag_applied_code == 1822602
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1823502 = mag_applied_code == 1823502
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1823702 = mag_applied_code == 1823702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1825502 = mag_applied_code == 1825502
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1827202 = mag_applied_code == 1827202
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1832102 = mag_applied_code == 1832102
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1832103 = mag_applied_code == 1832103
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1835202 = mag_applied_code == 1835202
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1835402 = mag_applied_code == 1835402
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1835602 = mag_applied_code == 1835602
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1836302 = mag_applied_code == 1836302
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1838702 = mag_applied_code == 1838702
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1849302 = mag_applied_code == 1849302
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1874101 = mag_applied_code == 1874101
    - }
    - gen A_`code' = mag_applied_code == `code'
    = gen A_1884201 = mag_applied_code == 1884201
    - }
    - foreach code of local mag_codes{
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1331101 = mag_offered_code == 1331101
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1350001 = mag_offered_code == 1350001
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1713701 = mag_offered_code == 1713701
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1739001 = mag_offered_code == 1739001
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1802802 = mag_offered_code == 1802802
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1803802 = mag_offered_code == 1803802
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1804702 = mag_offered_code == 1804702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1804703 = mag_offered_code == 1804703
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1806002 = mag_offered_code == 1806002
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1807502 = mag_offered_code == 1807502
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1808002 = mag_offered_code == 1808002
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1810302 = mag_offered_code == 1810302
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1810702 = mag_offered_code == 1810702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1811002 = mag_offered_code == 1811002
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1811202 = mag_offered_code == 1811202
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1811802 = mag_offered_code == 1811802
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1811803 = mag_offered_code == 1811803
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1812702 = mag_offered_code == 1812702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1813702 = mag_offered_code == 1813702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1815102 = mag_offered_code == 1815102
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1816802 = mag_offered_code == 1816802
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1817902 = mag_offered_code == 1817902
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1818202 = mag_offered_code == 1818202
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1820802 = mag_offered_code == 1820802
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1821702 = mag_offered_code == 1821702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1822602 = mag_offered_code == 1822602
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1823502 = mag_offered_code == 1823502
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1823702 = mag_offered_code == 1823702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1825502 = mag_offered_code == 1825502
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1827202 = mag_offered_code == 1827202
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1832102 = mag_offered_code == 1832102
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1832103 = mag_offered_code == 1832103
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1835202 = mag_offered_code == 1835202
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1835402 = mag_offered_code == 1835402
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1835602 = mag_offered_code == 1835602
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1836302 = mag_offered_code == 1836302
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1838702 = mag_offered_code == 1838702
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1849302 = mag_offered_code == 1849302
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1874101 = mag_offered_code == 1874101
    - }
    - gen Z_`code' = mag_offered_code == `code'
    = gen Z_1884201 = mag_offered_code == 1884201
    - }
    - gen Achoice= mag_applied_code
(315,141 missing values generated)
    - replace Achoice = 0 if missing(Achoice)
(315,141 real changes made)
    - egen enroll_one = rowtotal(D_*)
    - gen D_0 = enroll_one ==0
    - drop enroll_one
    - order Achoice, after(Dchoice)
    - order D_* A_* Z_*, after(Dchoice)
    - order D_0, after(Dchoice)
    - merge m:1 censusblockid using $DTAFINAL/distance_to_magnets_2004_2008.dta
> , gen(mergeDistance) keep(3)
    = merge m:1 censusblockid using /project/lausd/decentralized_choice/data/di
> stance_to_magnets_2004_2008.dta, gen(mergeDistance) keep(3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           251,661  (mergeDistance==3)
    -----------------------------------------
    - order d_*, after(Z_1884201)
    - foreach code of local mag_codes{
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1331101 = d_1331101 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1350001 = d_1350001 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1713701 = d_1713701 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1739001 = d_1739001 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1802802 = d_1802802 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1803802 = d_1803802 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1804702 = d_1804702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1804703 = d_1804703 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1806002 = d_1806002 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1807502 = d_1807502 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1808002 = d_1808002 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1810302 = d_1810302 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1810702 = d_1810702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1811002 = d_1811002 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1811202 = d_1811202 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1811802 = d_1811802 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1811803 = d_1811803 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1812702 = d_1812702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1813702 = d_1813702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1815102 = d_1815102 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1816802 = d_1816802 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1817902 = d_1817902 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1818202 = d_1818202 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1820802 = d_1820802 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1821702 = d_1821702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1822602 = d_1822602 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1823502 = d_1823502 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1823702 = d_1823702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1825502 = d_1825502 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1827202 = d_1827202 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1832102 = d_1832102 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1832103 = d_1832103 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1835202 = d_1835202 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1835402 = d_1835402 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1835602 = d_1835602 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1836302 = d_1836302 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1838702 = d_1838702 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1849302 = d_1849302 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1874101 = d_1874101 - nearest_schl_dist
(251,661 real changes made)
    - }
    - replace d_`code' = d_`code' - nearest_schl_dist
    = replace d_1884201 = d_1884201 - nearest_schl_dist
(251,661 real changes made)
    - }
    - order block_lat block_lon, after(d_1884201)
    - drop if missing(avg_Fela) | missing(avg_Fmath)
(28,029 observations deleted)
    - gen inconsistent_enrollment = 0
    - foreach code of local mag_codes {
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1331101 == 1 & Z_1331101 == 0
(268 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1350001 == 1 & Z_1350001 == 0
(192 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1713701 == 1 & Z_1713701 == 0
(375 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1739001 == 1 & Z_1739001 == 0
(217 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1802802 == 1 & Z_1802802 == 0
(202 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1803802 == 1 & Z_1803802 == 0
(114 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1804702 == 1 & Z_1804702 == 0
(38 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1804703 == 1 & Z_1804703 == 0
(86 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1806002 == 1 & Z_1806002 == 0
(202 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1807502 == 1 & Z_1807502 == 0
(179 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1808002 == 1 & Z_1808002 == 0
(57 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1810302 == 1 & Z_1810302 == 0
(81 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1810702 == 1 & Z_1810702 == 0
(44 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1811002 == 1 & Z_1811002 == 0
(127 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1811202 == 1 & Z_1811202 == 0
(96 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1811802 == 1 & Z_1811802 == 0
(23 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1811803 == 1 & Z_1811803 == 0
(30 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1812702 == 1 & Z_1812702 == 0
(113 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1813702 == 1 & Z_1813702 == 0
(146 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1815102 == 1 & Z_1815102 == 0
(219 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1816802 == 1 & Z_1816802 == 0
(64 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1817902 == 1 & Z_1817902 == 0
(75 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1818202 == 1 & Z_1818202 == 0
(90 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1820802 == 1 & Z_1820802 == 0
(101 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1821702 == 1 & Z_1821702 == 0
(125 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1822602 == 1 & Z_1822602 == 0
(137 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1823502 == 1 & Z_1823502 == 0
(211 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1823702 == 1 & Z_1823702 == 0
(74 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1825502 == 1 & Z_1825502 == 0
(96 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1827202 == 1 & Z_1827202 == 0
(143 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1832102 == 1 & Z_1832102 == 0
(112 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1832103 == 1 & Z_1832103 == 0
(54 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1835202 == 1 & Z_1835202 == 0
(84 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1835402 == 1 & Z_1835402 == 0
(138 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1835602 == 1 & Z_1835602 == 0
(107 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1836302 == 1 & Z_1836302 == 0
(264 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1838702 == 1 & Z_1838702 == 0
(6 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1849302 == 1 & Z_1849302 == 0
(85 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1874101 == 1 & Z_1874101 == 0
(169 real changes made)
    - }
    - replace inconsistent_enrollment = 1 if D_`code' == 1 & Z_`code' == 0
    = replace inconsistent_enrollment = 1 if D_1884201 == 1 & Z_1884201 == 0
(916 real changes made)
    - }
    - count if inconsistent_enrollment == 1
  5,860
    - local dropped = r(N)
    - drop if inconsistent_enrollment == 1
(5,860 observations deleted)
    - drop inconsistent_enrollment
    - display "Dropped `dropped' students who enrolled in schools they didn't r
> eceive offers from"
    = display "Dropped 5860 students who enrolled in schools they didn't receiv
> e offers from"
Dropped 5860 students who enrolled in schools they didn't receive offers from
    - drop studentclassofname esp_home ytdofattendeddays ytdofenrolleddays ytdo
> fabsentdays otherabsencecount ytdofattendance appabsencecount mergeATT num_of
> _suspensions_Class num_suspended_days_Class num_of_suspensions_In_school num_
> suspended_days_In_school num_of_suspensions_Out_of_school num_suspended_days_
> Out_of_school total_num_suspended_days total_num_suspensions mergeSuspensions
>  gpa_fall gpa_spring mergeGPA
    - drop mergeAFC mergeMagnet mergeDLE mergeACS mergePWT mergeSAS cst_ela cst
> _math z_cst_ela z_cst_math z_sbac_ela z_sbac_math
    - gen censustract = substr(censusblockid, 1, 11)
    - merge m:1 censustract using `census_tracts', gen(mergeCensus) keep(1 3)
    = merge m:1 censustract using /scratch/ryanlee22/15095981/St1456097.000002,
>  gen(mergeCensus) keep(1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           217,772  (mergeCensus==3)
    -----------------------------------------
    - gen any_missing_score = missing_math==1 | missing_ela ==1
    - gen current_in_mag = regexm(sname, "MAG") | regexm(sname, "MG") | regexm(
> sname, "SOCES") | regexm(sname, "LACES")
    - bys sname endyear : egen current_peer_quality =mean(lag_math)
    - gen applied = Achoice !=0
    - drop if applied==0 & appliedMagnet==1
(8,135 observations deleted)
    - sort endyear studentpseudoid
    - save $DTAFINAL/structural_data_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/structural_data_2004_2008.d
> ta, replace
file /project/lausd/decentralized_choice/data/structural_data_2004_2008.dta
    saved
    - gen rand = runiform()
    - sort rand
    - keep if rand <=0.25
(157,174 observations deleted)
    - drop rand
    - sort endyear studentpseudoid
    - save $DTAFINAL/structural_data_2004_2008_sample.dta, replace
    = save /project/lausd/decentralized_choice/data/structural_data_2004_2008_s
> ample.dta, replace
file
    /project/lausd/decentralized_choice/data/structural_data_2004_2008_sample
    > .dta saved
    ------------------------------------------------ end prepStructuralData ---
  - prepareSeats
    ---------------------------------------------------- begin prepareSeats ---
    - use $BUILD/magnet_cutoffs/prog_seats_app.dta, clear
    = use /project/lausd/build/output/data/magnet_cutoffs/prog_seats_app.dta, c
> lear
    - rename mag_cd_ schoolcostcentercode
    - rename app_endyear endyear
    - keep if endyear <=2008 & endyear>=2004
(25,836 observations deleted)
    - keep if stu_grade==6
(4,962 observations deleted)
    - merge m:1 schoolcostcentercode using $DTAFINAL/magnet_codes_2004_2008.dta
> , gen(mergeSchools) keep(3)
    = merge m:1 schoolcostcentercode using /project/lausd/decentralized_choice/
> data/magnet_codes_2004_2008.dta, gen(mergeSchools) keep(3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               358  (mergeSchools==3)
    -----------------------------------------
    - preserve
    - keep endyear schoolcostcentercode stu_grade phbao seats_available
    - rename seats_available seats_
    - reshape wide seats_, i(endyear stu_grade phbao) j(schoolcostcentercode)
(j = 1331101 1350001 1713701 1739001 1802802 1803802 1804702 1804703 1806002 18
> 07502 1808002 1810302 1810702 1811002 1811202 1811802 1811803 1812702 1813702
>  1815102 1816802 1817902 1818202 1820802 1821702 1822602 1823502 1823702 1825
> 502 1827202 1832102 1832103 1835202 1835402 1835602 1836302 1838702 1849302 1
> 874101 1884201)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              358   ->   10          
Number of variables                   5   ->   43          
j variable (40 values)schoolcostcentercode->   (dropped)
xij variables:
                                 seats_   ->   seats_1331101 seats_1350001 ... 
> seats_1884201
-----------------------------------------------------------------------------
    - ds seats_*
seat~1331101  seat~1806002  seat~1811803  seat~1821702  seat~1835202
seat~1350001  seat~1807502  seat~1812702  seat~1822602  seat~1835402
seat~1713701  seat~1808002  seat~1813702  seat~1823502  seat~1835602
seat~1739001  seat~1810302  seat~1815102  seat~1823702  seat~1836302
seat~1802802  seat~1810702  seat~1816802  seat~1825502  seat~1838702
seat~1803802  seat~1811002  seat~1817902  seat~1827202  seat~1849302
seat~1804702  seat~1811202  seat~1818202  seat~1832102  seat~1874101
seat~1804703  seat~1811802  seat~1820802  seat~1832103  seat~1884201
    - foreach var of varlist `r(varlist)'{
    = foreach var of varlist seats_1331101 seats_1350001 seats_1713701 seats_17
> 39001 seats_1802802 seats_1803802 seats_1804702 seats_1804703 seats_1806002 s
> eats_1807502 seats_1808002 seats_1810302 seats_1810702 seats_1811002 seats_18
> 11202 seats_1811802 seats_1811803 seats_1812702 seats_1813702 seats_1815102 s
> eats_1816802 seats_1817902 seats_1818202 seats_1820802 seats_1821702 seats_18
> 22602 seats_1823502 seats_1823702 seats_1825502 seats_1827202 seats_1832102 s
> eats_1832103 seats_1835202 seats_1835402 seats_1835602 seats_1836302 seats_18
> 38702 seats_1849302 seats_1874101 seats_1884201{
    - replace `var' = 0 if missing(`var')
    = replace seats_1331101 = 0 if missing(seats_1331101)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1350001 = 0 if missing(seats_1350001)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1713701 = 0 if missing(seats_1713701)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1739001 = 0 if missing(seats_1739001)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1802802 = 0 if missing(seats_1802802)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1803802 = 0 if missing(seats_1803802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1804702 = 0 if missing(seats_1804702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1804703 = 0 if missing(seats_1804703)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1806002 = 0 if missing(seats_1806002)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1807502 = 0 if missing(seats_1807502)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1808002 = 0 if missing(seats_1808002)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1810302 = 0 if missing(seats_1810302)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1810702 = 0 if missing(seats_1810702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1811002 = 0 if missing(seats_1811002)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1811202 = 0 if missing(seats_1811202)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1811802 = 0 if missing(seats_1811802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1811803 = 0 if missing(seats_1811803)
(2 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1812702 = 0 if missing(seats_1812702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1813702 = 0 if missing(seats_1813702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1815102 = 0 if missing(seats_1815102)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1816802 = 0 if missing(seats_1816802)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1817902 = 0 if missing(seats_1817902)
(2 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1818202 = 0 if missing(seats_1818202)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1820802 = 0 if missing(seats_1820802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1821702 = 0 if missing(seats_1821702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1822602 = 0 if missing(seats_1822602)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1823502 = 0 if missing(seats_1823502)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1823702 = 0 if missing(seats_1823702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1825502 = 0 if missing(seats_1825502)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1827202 = 0 if missing(seats_1827202)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1832102 = 0 if missing(seats_1832102)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1832103 = 0 if missing(seats_1832103)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1835202 = 0 if missing(seats_1835202)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1835402 = 0 if missing(seats_1835402)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1835602 = 0 if missing(seats_1835602)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1836302 = 0 if missing(seats_1836302)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1838702 = 0 if missing(seats_1838702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1849302 = 0 if missing(seats_1849302)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1874101 = 0 if missing(seats_1874101)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace seats_1884201 = 0 if missing(seats_1884201)
(0 real changes made)
    - }
    - save $DTAFINAL/prog_seats_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/prog_seats_2004_2008.dta, r
> eplace
file /project/lausd/decentralized_choice/data/prog_seats_2004_2008.dta saved
    - restore
    - preserve
    - collapse (sum) applications seats_available, by(schoolcostcentercode)
    - gen p = seats_available / applications
    - replace p = 1 if seats_available> applications & !missing(seats_available
> )
(8 real changes made)
    - save $DTAFINAL/aggregate_prog_admission_prob_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/aggregate_prog_admission_pr
> ob_2004_2008.dta, replace
file
    /project/lausd/decentralized_choice/data/aggregate_prog_admission_prob_20
    > 04_2008.dta saved
    - restore
    - gen p_i = seats_available /applications
    - replace p_i = 1 if seats_available> applications & !missing(seats_availab
> le)
(98 real changes made)
    - replace p_i = 0 if missing(p_i)
(0 real changes made)
    - keep endyear schoolcostcentercode stu_grade phbao p_i
    - rename p_i p_i_
    - reshape wide p_i_ , i(endyear stu_grade phbao ) j(schoolcostcentercode )
(j = 1331101 1350001 1713701 1739001 1802802 1803802 1804702 1804703 1806002 18
> 07502 1808002 1810302 1810702 1811002 1811202 1811802 1811803 1812702 1813702
>  1815102 1816802 1817902 1818202 1820802 1821702 1822602 1823502 1823702 1825
> 502 1827202 1832102 1832103 1835202 1835402 1835602 1836302 1838702 1849302 1
> 874101 1884201)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              358   ->   10          
Number of variables                   5   ->   43          
j variable (40 values)schoolcostcentercode->   (dropped)
xij variables:
                                   p_i_   ->   p_i_1331101 p_i_1350001 ... p_i_
> 1884201
-----------------------------------------------------------------------------
    - ds p_i_*
p_i_1331101  p_i_1804703  p_i_1811202  p_i_1817902  p_i_1825502  p_i_1836302
p_i_1350001  p_i_1806002  p_i_1811802  p_i_1818202  p_i_1827202  p_i_1838702
p_i_1713701  p_i_1807502  p_i_1811803  p_i_1820802  p_i_1832102  p_i_1849302
p_i_1739001  p_i_1808002  p_i_1812702  p_i_1821702  p_i_1832103  p_i_1874101
p_i_1802802  p_i_1810302  p_i_1813702  p_i_1822602  p_i_1835202  p_i_1884201
p_i_1803802  p_i_1810702  p_i_1815102  p_i_1823502  p_i_1835402
p_i_1804702  p_i_1811002  p_i_1816802  p_i_1823702  p_i_1835602
    - foreach var of varlist `r(varlist)'{
    = foreach var of varlist p_i_1331101 p_i_1350001 p_i_1713701 p_i_1739001 p_
> i_1802802 p_i_1803802 p_i_1804702 p_i_1804703 p_i_1806002 p_i_1807502 p_i_180
> 8002 p_i_1810302 p_i_1810702 p_i_1811002 p_i_1811202 p_i_1811802 p_i_1811803 
> p_i_1812702 p_i_1813702 p_i_1815102 p_i_1816802 p_i_1817902 p_i_1818202 p_i_1
> 820802 p_i_1821702 p_i_1822602 p_i_1823502 p_i_1823702 p_i_1825502 p_i_182720
> 2 p_i_1832102 p_i_1832103 p_i_1835202 p_i_1835402 p_i_1835602 p_i_1836302 p_i
> _1838702 p_i_1849302 p_i_1874101 p_i_1884201{
    - replace `var' = 0 if missing(`var')
    = replace p_i_1331101 = 0 if missing(p_i_1331101)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1350001 = 0 if missing(p_i_1350001)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1713701 = 0 if missing(p_i_1713701)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1739001 = 0 if missing(p_i_1739001)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1802802 = 0 if missing(p_i_1802802)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1803802 = 0 if missing(p_i_1803802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1804702 = 0 if missing(p_i_1804702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1804703 = 0 if missing(p_i_1804703)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1806002 = 0 if missing(p_i_1806002)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1807502 = 0 if missing(p_i_1807502)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1808002 = 0 if missing(p_i_1808002)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1810302 = 0 if missing(p_i_1810302)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1810702 = 0 if missing(p_i_1810702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1811002 = 0 if missing(p_i_1811002)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1811202 = 0 if missing(p_i_1811202)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1811802 = 0 if missing(p_i_1811802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1811803 = 0 if missing(p_i_1811803)
(2 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1812702 = 0 if missing(p_i_1812702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1813702 = 0 if missing(p_i_1813702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1815102 = 0 if missing(p_i_1815102)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1816802 = 0 if missing(p_i_1816802)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1817902 = 0 if missing(p_i_1817902)
(2 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1818202 = 0 if missing(p_i_1818202)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1820802 = 0 if missing(p_i_1820802)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1821702 = 0 if missing(p_i_1821702)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1822602 = 0 if missing(p_i_1822602)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1823502 = 0 if missing(p_i_1823502)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1823702 = 0 if missing(p_i_1823702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1825502 = 0 if missing(p_i_1825502)
(4 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1827202 = 0 if missing(p_i_1827202)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1832102 = 0 if missing(p_i_1832102)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1832103 = 0 if missing(p_i_1832103)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1835202 = 0 if missing(p_i_1835202)
(1 real change made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1835402 = 0 if missing(p_i_1835402)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1835602 = 0 if missing(p_i_1835602)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1836302 = 0 if missing(p_i_1836302)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1838702 = 0 if missing(p_i_1838702)
(3 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1849302 = 0 if missing(p_i_1849302)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1874101 = 0 if missing(p_i_1874101)
(0 real changes made)
    - }
    - replace `var' = 0 if missing(`var')
    = replace p_i_1884201 = 0 if missing(p_i_1884201)
(0 real changes made)
    - }
    - save $DTAFINAL/prog_seats_app_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/prog_seats_app_2004_2008.dt
> a, replace
file /project/lausd/decentralized_choice/data/prog_seats_app_2004_2008.dta
    saved
    ------------------------------------------------------ end prepareSeats ---
  - student_p_i
    ----------------------------------------------------- begin student_p_i ---
    - use $DTAFINAL/structural_data_2004_2008.dta, clear
    = use /project/lausd/decentralized_choice/data/structural_data_2004_2008.dt
> a, clear
    - gen phbao = (black==1 | asian==1 | hispanic==1 | other==1)
    - gen stu_grade = 6
    - merge m:1 phbao stu_grade endyear using $DTAFINAL/prog_seats_app_2004_200
> 8.dta, gen(mergeP) keep( 1 3)
    = merge m:1 phbao stu_grade endyear using /project/lausd/decentralized_choi
> ce/data/prog_seats_app_2004_2008.dta, gen(mergeP) keep( 1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           209,637  (mergeP==3)
    -----------------------------------------
    - sort endyear studentpseudoid
    - keep studentpseudoid endyear p_i_*
    - save $DTAFINAL/student_p_i_2004_2008.dta, replace
    = save /project/lausd/decentralized_choice/data/student_p_i_2004_2008.dta, 
> replace
file /project/lausd/decentralized_choice/data/student_p_i_2004_2008.dta saved
    - use $DTAFINAL/structural_data_2004_2008_sample.dta, clear
    = use /project/lausd/decentralized_choice/data/structural_data_2004_2008_sa
> mple.dta, clear
    - gen phbao = (black==1 | asian==1 | hispanic==1 | other==1)
    - gen stu_grade = 6
    - merge m:1 phbao stu_grade endyear using $DTAFINAL/prog_seats_app_2004_200
> 8.dta, gen(mergeP) keep(1 3)
    = merge m:1 phbao stu_grade endyear using /project/lausd/decentralized_choi
> ce/data/prog_seats_app_2004_2008.dta, gen(mergeP) keep(1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,463  (mergeP==3)
    -----------------------------------------
    - sort endyear studentpseudoid
    - keep studentpseudoid endyear p_i_*
    - save $DTAFINAL/student_p_i_2004_2008_sample.dta, replace
    = save /project/lausd/decentralized_choice/data/student_p_i_2004_2008_sampl
> e.dta, replace
file
    /project/lausd/decentralized_choice/data/student_p_i_2004_2008_sample.dta
    saved
    ------------------------------------------------------- end student_p_i ---
  ---------------------------------------------------------------- end main ---

. 
. 
end of do-file
